<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKYSAFE - Fall Prevention System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', sans-serif; }
        :root {
            --primary-yellow: #F59E0B;
            --primary-yellow-light: #FCD34D;
            --warning-red: #EF4444;
            --success-green: #22C55E;
            --bg-light: #FFFFFF;
            --bg-secondary: #F9FAFB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
        }

        /* CHANGE 1: Theme presets */
        .theme-ironman {
            --primary-yellow: #D97706;         /* accent (gold) */
            --primary-yellow-light: #FDE68A;
            --accent-strong: #B91C1C;          /* deep red */
            --bg-light: #FFFFFF;
            --bg-secondary: #FFF7ED;
            --text-primary: #111827;
            --text-secondary: #6B7280;
        }

        .theme-captain {
            --primary-yellow: #0EA5E9;         /* using as accent (blue) */
            --primary-yellow-light: #93C5FD;
            --accent-strong: #DC2626;          /* red */
            --bg-light: #FFFFFF;
            --bg-secondary: #F0F9FF;
            --text-primary: #0F172A;
            --text-secondary: #475569;
        }

        .theme-elementals {
            --primary-yellow: #06B6D4;         /* teal-cyan accent */
            --primary-yellow-light: #67E8F9;
            --accent-strong: #F97316;          /* orange (fire) */
            --bg-light: #FCFEFF;
            --bg-secondary: #F8FAFC;
            --text-primary: #0F172A;
            --text-secondary: #475569;
        }

        .theme-matteblack {
            --primary-yellow: #374151;         /* muted gray accent */
            --primary-yellow-light: #6B7280;
            --accent-strong: #f59e0b;          /* small warm accent */
            --bg-light: #0B0B0B;
            --bg-secondary: #0F1724;
            --text-primary: #E6E6E6;
            --text-secondary: #9CA3AF;
            color-scheme: dark;
        }

        .dark {
            --bg-light: #111827;
            --bg-secondary: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
        }
        body {
            background-color: var(--bg-light);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .screen { display: none; }
        .screen.active { display: flex; }
        
        /* Dynamic Primary Coloring */
        .nav-item.active { color: var(--primary-yellow); border-top: 2px solid var(--primary-yellow); }
        .bg-primary-theme { background-color: var(--primary-yellow); }
        .text-yellow-600 { color: var(--primary-yellow); }
        
        .status-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .refresh-spinner { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .card-bg {
            background-color: var(--bg-secondary);
            transition: background-color 0.3s;
        }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .bg-main { background-color: var(--bg-light); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes alarm-flash {
            0%, 100% { background-color: #7f1d1d; }
            50% { background-color: #ef4444; }
        }
        .alarm-state { animation: alarm-flash 1s infinite; }
    </style>
</head>
<body class="bg-main min-h-screen">
    <div id="app" class="max-w-md mx-auto bg-main min-h-screen relative">
        
        <div id="loginScreen" class="screen active flex-col min-h-screen justify-center items-center p-6 fade-in">
            <div class="text-center mb-10">
                <div class="w-24 h-24 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg" id="loginLogo">
                    <i class="fas fa-shield-alt text-white text-4xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-primary">SKYSAFE</h1>
                <p class="text-secondary mt-2">Fall Prevention System</p>
            </div>
            
            <div class="w-full max-w-sm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-secondary mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-yellow-400 focus:outline-none bg-white text-gray-800" placeholder="Enter username">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-secondary mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-yellow-400 focus:outline-none bg-white text-gray-800" placeholder="Enter password">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary mb-2">Role</label>
                    <select id="userRole" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-yellow-400 focus:outline-none bg-white text-gray-800">
                        <option value="admin">Admin</option>
                        <option value="engineer">Maintenance Engineer</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-white font-semibold py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                    Sign In
                </button>
                <p id="loginError" class="text-red-500 text-center mt-4 hidden">Invalid credentials</p>
            </div>
            <p class="text-secondary text-sm mt-8">Secure Access Portal v2.1</p>
        </div>

        <div id="mainApp" class="hidden flex-col min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-500 px-4 py-4 sticky top-0 z-50" id="mainHeader">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-shield-alt text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-white font-bold text-lg">SKYSAFE</h1>
                            <p class="text-white/80 text-xs" id="headerRole">Admin</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="systemStatusBadge" class="px-3 py-1 rounded-full bg-green-500 text-white text-xs font-semibold">NORMAL</div>
                        <button onclick="handleLogout()" class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-sign-out-alt text-white"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div id="pullIndicator" class="text-center py-0 overflow-hidden transition-all duration-300" style="height: 0px;">
                <div class="py-4 flex flex-col items-center justify-center">
                    <div id="pullIcon" class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mb-2">
                        <i id="pullIconInner" class="fas fa-arrow-down text-yellow-500 text-lg"></i>
                    </div>
                    <p id="pullText" class="text-yellow-600 font-medium text-sm">Pull down to refresh</p>
                </div>
            </div>

            <main id="contentArea" class="flex-1 overflow-y-auto scrollbar-hide pb-20" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd()">
                
                <div id="dashboardScreen" class="screen active flex-col p-4 fade-in">
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-primary mb-1">System Dashboard</h2>
                            <p class="text-secondary text-sm">Real-time monitoring overview</p>
                        </div>
                        <button onclick="manualRefreshDashboard()" id="dashRefreshBtn" class="w-10 h-10 bg-yellow-100 rounded-xl flex items-center justify-center">
                            <i id="dashRefreshIcon" class="fas fa-sync-alt text-yellow-600"></i>
                        </button>
                    </div>

                    <div id="mainStatusCard" class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 mb-4 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-white/80 text-sm">System Status</p>
                                <h3 id="mainStatus" class="text-white text-2xl font-bold">NORMAL</h3>
                            </div>
                            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center status-pulse">
                                <i id="mainStatusIcon" class="fas fa-check-circle text-white text-3xl"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="bg-white/10 rounded-xl p-3">
                                <p class="text-white/70 text-xs">Building ID</p>
                                <p class="text-white font-semibold">BLD-2024-A1</p>
                            </div>
                            <div class="bg-white/10 rounded-xl p-3">
                                <p class="text-white/70 text-xs">Last Update</p>
                                <p id="lastUpdate" class="text-white font-semibold">--:--:--</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="card-bg rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center"><i class="fas fa-satellite-dish text-yellow-500"></i></div>
                                <div><p class="text-secondary text-xs">Sensors</p><p class="text-primary font-bold text-lg">2/2</p></div>
                            </div>
                        </div>
                        <div class="card-bg rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-bolt text-green-500"></i></div>
                                <div><p class="text-secondary text-xs">Power</p><p class="text-primary font-bold text-lg">MAIN</p></div>
                            </div>
                        </div>
                    </div>

                    <div class="card-bg rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-primary">Recent Activity</h4>
                            <span class="text-yellow-500 text-sm cursor-pointer" onclick="switchTab('logs')">View All</span>
                        </div>
                        <div id="recentEvents" class="space-y-2"></div>
                    </div>
                </div>

                <div id="settingsScreen" class="screen flex-col p-4 fade-in">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-primary mb-1">Settings</h2>
                        <p class="text-secondary text-sm">System configuration</p>
                    </div>

                    <div class="card-bg rounded-2xl p-5 mb-4">
                        <h4 class="font-semibold text-primary mb-4">UI Preferences</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gray-800 rounded-xl flex items-center justify-center"><i class="fas fa-moon text-white"></i></div>
                                    <div><p class="text-primary font-medium">Dark Mode</p><p class="text-secondary text-xs">Switch theme</p></div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="darkModeToggle" class="sr-only peer" onchange="toggleDarkMode()">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-400"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-yellow-100 rounded-xl flex items-center justify-center" id="themePreviewSwatch">
                                        <i class="fas fa-palette text-yellow-500"></i>
                                    </div>
                                    <div>
                                        <p class="text-primary font-medium">Theme</p>
                                        <p id="themeDescription" class="text-secondary text-xs">Default</p>
                                    </div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <button type="button" class="theme-btn p-1 rounded-lg transition-all" data-theme="default" title="Default" onclick="selectTheme('default')">
                                        <div class="w-6 h-4 rounded-sm bg-gradient-to-r from-yellow-400 to-yellow-500"></div>
                                    </button>
                                    <button type="button" class="theme-btn p-1 rounded-lg transition-all" data-theme="ironman" title="Iron Man" onclick="selectTheme('ironman')">
                                        <div class="w-6 h-4 rounded-sm bg-gradient-to-r from-red-600 to-yellow-400"></div>
                                    </button>
                                    <button type="button" class="theme-btn p-1 rounded-lg transition-all" data-theme="captain" title="Captain America" onclick="selectTheme('captain')">
                                        <div class="w-6 h-4 rounded-sm bg-gradient-to-r from-blue-600 to-red-600"></div>
                                    </button>
                                    <button type="button" class="theme-btn p-1 rounded-lg transition-all" data-theme="elementals" title="Elementals" onclick="selectTheme('elementals')">
                                        <div class="w-6 h-4 rounded-sm bg-gradient-to-r from-emerald-500 to-orange-400"></div>
                                    </button>
                                    <button type="button" class="theme-btn p-1 rounded-lg transition-all" data-theme="matteblack" title="Matte Black" onclick="selectTheme('matteblack')">
                                        <div class="w-6 h-4 rounded-sm bg-gray-800"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="maintenanceModeSection" class="card-bg rounded-2xl p-5 mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center"><i class="fas fa-tools text-orange-500"></i></div>
                                <div><p class="text-primary font-medium">Maintenance Mode</p><p class="text-secondary text-xs">Admin access</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="maintenanceToggle" class="sr-only peer" onchange="toggleMaintenance()">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-orange-400 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="sensorsScreen" class="screen flex-col p-4 fade-in">
                    <h2 class="text-xl font-bold text-primary mb-6">Sensor Monitoring</h2>
                    <div class="card-bg rounded-2xl p-5 mb-4 border-l-4 border-yellow-400">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center"><i class="fas fa-wave-square text-yellow-500 text-xl"></i></div>
                            <div><h4 class="font-semibold text-primary">Ultrasonic</h4><p id="ultrasonicDistance" class="text-primary text-2xl font-bold">-- cm</p></div>
                        </div>
                    </div>
                </div>

                <div id="logsScreen" class="screen flex-col p-4 fade-in">
                    <h2 class="text-xl font-bold text-primary mb-6">Event History</h2>
                    <div id="logEntries" class="space-y-3"></div>
                </div>

            </main>

            <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 max-w-md mx-auto">
                <div class="flex justify-around py-2">
                    <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center py-2 px-3 text-gray-500"><i class="fas fa-home text-lg mb-1"></i><span class="text-xs">Home</span></button>
                    <button onclick="switchTab('sensors')" class="nav-item flex flex-col items-center py-2 px-3 text-gray-500"><i class="fas fa-satellite-dish text-lg mb-1"></i><span class="text-xs">Sensors</span></button>
                    <button onclick="switchTab('logs')" class="nav-item flex flex-col items-center py-2 px-3 text-gray-500"><i class="fas fa-history text-lg mb-1"></i><span class="text-xs">Logs</span></button>
                    <button onclick="switchTab('settings')" class="nav-item flex flex-col items-center py-2 px-3 text-gray-500"><i class="fas fa-cog text-lg mb-1"></i><span class="text-xs">Settings</span></button>
                </div>
            </nav>
        </div>
    </div>

    <script>
        // ===================
        // Global State
        // ===================
        let currentUser = null;
        let isDarkMode = false;
        let isMaintenanceMode = false;
        let uptimeSeconds = 0;
        let eventLogs = [
            { id: 1, type: 'maintenance', title: 'System Boot', description: 'SKYSAFE initialized', time: new Date(), sensors: ['System'], action: 'Success' }
        ];

        // ===================
        // CHANGE 3: Theme logic
        // ===================
        const THEMES = {
            default: '',
            ironman: 'theme-ironman',
            captain: 'theme-captain',
            elementals: 'theme-elementals',
            matteblack: 'theme-matteblack'
        };

        function applyTheme(key) {
            Object.values(THEMES).forEach(cls => {
                if (cls) document.documentElement.classList.remove(cls);
            });

            const cls = THEMES[key] || THEMES.default;
            if (cls) document.documentElement.classList.add(cls);

            localStorage.setItem('skysafe_theme', key);

            const desc = {
                default: 'Yellow & White (Default)',
                ironman: 'Iron Man — Red & Gold',
                captain: 'Captain America — Blue & Red',
                elementals: 'Elementals — Teal & Fire',
                matteblack: 'Matte Black — Dark UI'
            }[key] || 'Custom';

            const themeDescription = document.getElementById('themeDescription');
            const preview = document.getElementById('themePreviewSwatch');
            if (themeDescription) themeDescription.textContent = desc;
            
            if (preview) {
                // Reset classes
                preview.className = 'w-10 h-10 rounded-xl flex items-center justify-center ';
                const icon = preview.querySelector('i');
                icon.className = 'fas fa-palette ';

                if (key === 'matteblack') {
                    preview.classList.add('bg-gray-900');
                    icon.classList.add('text-white');
                } else if (key === 'ironman') {
                    preview.classList.add('bg-gradient-to-r', 'from-red-600', 'to-yellow-400');
                    icon.classList.add('text-white');
                } else if (key === 'captain') {
                    preview.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-red-600');
                    icon.classList.add('text-white');
                } else if (key === 'elementals') {
                    preview.classList.add('bg-gradient-to-r', 'from-emerald-400', 'to-orange-400');
                    icon.classList.add('text-white');
                } else {
                    preview.classList.add('bg-yellow-100');
                    icon.classList.add('text-yellow-500');
                }
            }
        }

        function loadTheme() {
            const saved = localStorage.getItem('skysafe_theme') || 'default';
            applyTheme(saved);
            selectTheme(saved); // Visual ring update
        }

        function selectTheme(key) {
            applyTheme(key);
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-yellow-400'));
            const btn = document.querySelector(`.theme-btn[data-theme="${key}"]`);
            if (btn) btn.classList.add('ring-2', 'ring-yellow-400');
        }

        // ===================
        // Core Logic
        // ===================
        function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (user === 'MEKG' && pass === '@MEKS1') {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('mainApp').classList.remove('hidden');
                initializeApp();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(tabName + 'Screen').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('skySafeDarkMode', isDarkMode);
        }

        function initializeApp() {
            renderLogs();
            renderRecentEvents();
            setInterval(() => {
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                document.getElementById('ultrasonicDistance').textContent = (Math.floor(Math.random()*100) + 150) + ' cm';
            }, 2000);
        }

        function renderLogs() {
            const container = document.getElementById('logEntries');
            if(!container) return;
            container.innerHTML = eventLogs.map(log => `
                <div class="card-bg rounded-xl p-4">
                    <div class="flex justify-between">
                        <h4 class="font-semibold text-primary">${log.title}</h4>
                        <span class="text-xs text-secondary">${log.time.toLocaleTimeString()}</span>
                    </div>
                    <p class="text-secondary text-sm">${log.description}</p>
                </div>
            `).join('');
        }

        function renderRecentEvents() {
            const container = document.getElementById('recentEvents');
            if(!container) return;
            container.innerHTML = `<div class="p-2 bg-white/50 dark:bg-gray-700 rounded-lg text-sm">System running normally.</div>`;
        }

        function handleLogout() { location.reload(); }

        // CHANGE 4: Early load
        loadTheme();
        if(localStorage.getItem('skySafeDarkMode') === 'true') {
            isDarkMode = true;
            document.documentElement.classList.add('dark');
            const dt = document.getElementById('darkModeToggle');
            if(dt) dt.checked = true;
        }
    </script>
</body>
</html>
